{% load static %}
{% load custom_filters %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #121212;
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .outer-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
    }

    .dashboard-box {
      width: 100%;
      max-width: 1800px;
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
      border: 2px solid #444;
    }

    h2 {
      font-weight: bold;
      text-transform: uppercase;
      color: #fff;
      text-align: center;
      margin-bottom: 40px;
    }

    .section-box {
      background-color: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      padding: 30px;
      overflow-x: auto;
    }

    .donation-box {
      border: 2px solid #dc3545;
      box-shadow: 0 0 12px rgba(220, 53, 69, 0.4);
    }

    .request-box {
      border: 2px solid #ffc107;
      box-shadow: 0 0 12px rgba(255, 193, 7, 0.4);
    }

    .summary-box {
      border: 2px solid #0d6efd;
      box-shadow: 0 0 12px rgba(13, 110, 253, 0.4);
    }

    .section-box table {
      width: 100%;
      border-collapse: collapse;
    }

    .section-box table th,
    .section-box table td {
      padding: 8px 12px;
      font-size: 0.9rem;
      vertical-align: middle;
      text-align: center;
      white-space: nowrap;
    }

    .section-box table tbody tr:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }

    .section-box table thead th {
      position: sticky;
      top: 0;
      background-color: #1e1e1e;
      z-index: 1;
    }

    td:first-child {
      max-width: 220px;
    }

    table th {
      font-weight: 600;
    }

    .admin-links a {
      margin-right: 10px;
    }

    .scroll-box {
      overflow-x: auto;
      width: 100%;
    }

    .recent-table {
      width: max-content;
      table-layout: auto;
      white-space: nowrap;
    }

    @media (max-width: 768px) {
      .section-box {
        padding: 20px;
      }

      .dashboard-box {
        padding: 20px;
      }

      .recent-table {
        min-width: 1000px;
      }
    }
  </style>
</head>
<body>

<!-- üî∫ Admin Navbar -->
<nav class="navbar bg-dark border-bottom border-light justify-content-center py-3">
  <a href="{% url 'home' %}" class="navbar-brand mb-0 h1 text-light text-decoration-none" style="font-family: 'Segoe UI', sans-serif; font-size: 2rem;">
    BLOOD BANK MANAGEMENT
  </a>
  <!-- üö™ Logout Button -->
  <form method="post" action="{% url 'logout' %}" class="position-absolute end-0 top-50 translate-middle-y me-4">
    {% csrf_token %}
    <button type="submit" class="btn btn-outline-danger btn-sm">
      Logout
    </button>
  </form>
</nav>

<div class="outer-wrapper">
  <div class="dashboard-box">

    <h2>ADMIN DASHBOARD</h2>

    <!-- ‚úÖ Verification Summary -->
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="section-box donation-box h-100">
          <h4 class="text-danger mb-3">Donor Verification</h4>
          <p>‚úÖ Verified: <strong>{{ verified_donors|length }}</strong></p>
          <p>‚ùå Unverified: <strong>{{ unverified_donors|length }}</strong></p>
        </div>
      </div>
      <div class="col-md-6">
        <div class="section-box request-box h-100">
          <h4 class="text-warning mb-3">Request Verification</h4>
          <p>‚úÖ Verified: <strong>{{ verified_requests|length }}</strong></p>
          <p>‚ùå Unverified: <strong>{{ unverified_requests|length }}</strong></p>
        </div>
      </div>
    </div>

    <!-- ü©∏ Unified Blood Summary Table -->
    <div class="section-box summary-box mb-4">
      <h4 class="text-info mb-3">Blood Summary</h4>
      <table class="table table-bordered table-dark table-striped text-center mb-0">
        <thead>
          <tr>
            <th>Blood Type</th>
            <th>
              Donated (Unit)<br>
              <small class="text-warning">(1 unit = 450 mL)</small>
            </th>
            <th>Requested (mL)</th>
            <th>Available (mL)</th>
          </tr>
        </thead>
        <tbody>
          {% for bt in blood_types %}
          <tr>
            <td>{{ bt }}</td>
            <td>{{ donor_blood_summary|get_item:bt|default:0 }}</td>
            <td>{{ request_blood_summary|get_item:bt|default:0 }}</td>
            <td>{{ available_blood_summary|get_item:bt|default:0 }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- üìÖ Recent Activity -->
    <div class="row mb-4">
      <!-- Donations -->
      <div class="col-md-6">
        <div class="section-box donation-box">
          <h4 class="text-danger mb-3">Recent Donations</h4>
          <div class="scroll-box">
            <table class="table table-bordered text-center table-dark table-striped mb-0 recent-table">
              <thead>
                <tr>
                  <th>Donor</th>
                  <th>Date</th>
                  <th>Location</th>
                  <th>Units</th>
                  <th>Available</th>
                  <th>Notes</th>
                  <th>Verified</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {% for d in recent_donors %}
                <tr>
                  <td>
                    {{ d.user.get_full_name|default:d.user.username }}<br>
                    <small style="color: #ffc107;">{{ d.user.email }}</small>
                  </td>
                  <td>{{ d.donation_date|date:"F j, Y" }}</td>
                  <td>{{ d.location }}</td>
                  <td>{{ d.units_donated }}</td>
                  <td>{{ d.available|yesno:"‚úÖ,‚ùå" }}</td>
                  <td>{{ d.notes|default:"‚Äî" }}</td>
                  <td>{{ d.verified|yesno:"‚úÖ,‚ùå" }}</td>
                  <td class="text-center">
                    <div class="d-inline-flex gap-2 justify-content-center">
                      <form method="post" action="{% url 'toggle_verification' d.id %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-warning">
                          {% if d.verified %}Unverify{% else %}Verify{% endif %}
                        </button>
                      </form>
                      <form method="post" action="{% url 'delete_donor' d.id %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this donor?');">
                          Delete
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="8" class="text-muted">No recent donations</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Requests -->
      <div class="col-md-6">
        <div class="section-box request-box">
          <h4 class="text-warning mb-3">Recent Requests</h4>
          <div class="scroll-box">
            <table class="table table-bordered text-center table-dark table-striped mb-0 recent-table">
              <thead>
                <tr>
                  <th>Requester</th>
                  <th>Date</th>
                  <th>Location</th>
                  <th>Patient</th>
                  <th>Age</th>
                  <th>Blood</th>
                  <th>Quantity</th>
                  <th>Verified</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {% for r in recent_requests %}
                <tr>
                  <td>
                    {{ r.user.get_full_name|default:r.user.username }}<br>
                    <small style="color: #ffc107;">{{ r.user.email }}</small>
                  </td>
                  <td>{{ r.requested_date|date:"F j, Y" }}</td>
                  <td>{{ r.location }}</td>
                  <td>{{ r.patient_name }}</td>
                  <td>{{ r.age }}</td>
                  <td>{{ r.blood_type }}</td>
                  <td>{{ r.quantity_needed }} mL</td>
                  <td>{{ r.verified|yesno:"‚úÖ,‚ùå" }}</td>
                  <td class="text-center">
                    <div class="d-inline-flex gap-2 justify-content-center">
                      <form method="post" action="{% url 'toggle_request_verification' r.id %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-warning">
                          {% if r.verified %}Unverify{% else %}Verify{% endif %}
                        </button>
                      </form>
                      <form method="post" action="{% url 'delete_requester' r.id %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this request?');">
                          Delete
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="9" class="text-muted">No recent requests</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- üîó Admin Links -->
    <div class="text-center mt-5 mb-4 admin-links d-flex flex-wrap justify-content-center gap-3">
      <a href="{% url 'lockout_dashboard' %}" class="btn btn-outline-light">üîê Lockout Dashboard</a>
      <a href="{% url 'download_report_pdf' %}" class="btn btn-danger" target="_blank">
        üìÑ Download Blood Report (PDF)
      </a>
    </div>

    <!-- üë£ Footer -->
    <footer class="text-center mt-5 text-light">
      <p class="mb-0 d-flex justify-content-center align-items-center gap-3 flex-wrap">
        Made with ‚ù§Ô∏è by Dino ¬∑
        <span onclick="copyEmail()" onkeypress="if(event.key==='Enter'){copyEmail()}" tabindex="0" role="button" style="cursor: pointer; color: #ffc107;" title="Click to copy">
          jacksondino00@gmail.com
        </span>
        <a href="{% url 'about' %}" class="btn btn-outline-warning btn-sm">About Me</a>
      </p>
    </footer>

    <!-- üìã Email Copy Script -->
    <script>
      function copyEmail() {
        const email = "jacksondino00@gmail.com";
        navigator.clipboard.writeText(email).then(() => {
          alert("Email copied to clipboard! üìã");
        }, () => {
          alert("Failed to copy email.");
        });
      }
    </script>

  </div> <!-- dashboard-box -->
</div> <!-- outer-wrapper -->

</body>
</html>
